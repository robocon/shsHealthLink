TRUNCATE TABLE `client_diagnostic_report`;
INSERT INTO `client_diagnostic_report` (`source_id`, `id`, `patient_cid`, `encounter_id`, `status`, `category_display`, `category_code`, `category_system`, `code_display`, `code_code`, `code_system`, `effective_date_time`, `effective_period_start`, `effective_period_end`, `performer`, `results_interpreter`, `conclusion`, `conclusion_display`, `conclusion_code`, `deleted`, `last_update_date_time`) 
SELECT 
'001151200' AS `source_id`,
x.`autonumber` AS `id`,
y.`idcard` AS `patient_cid`,
y.`row_id` AS `encounter_id`,
'final' AS `status`,
'Laboratory' AS `category_display`,
'LAB' AS `category_code`,
'hl7-diagnostic-report-category' AS `category_system`,
z.`detail` AS `code_display`,
z.`TMLT` AS `code_code`,
'http://this.or.th/index_TMLT.php' AS `code_system`,
x.`orderdate` AS `effective_date_time`,
'' AS `effective_period_start`,
'' AS `effective_period_end`,
'001151200' AS `performer`,
'' AS `results_interpreter`,
'' AS `conclusion`,
'' AS `conclusion_display`,
'' AS `conclusion_code`,
0 AS `deleted`,
x.`orderdate` AS `last_update_date_time`
FROM ( 
	SELECT a.`autonumber`,a.`labnumber`,a.`orderdate`,a.`profilecode`,a.`testgroupname`,a.`thdatehn`,b.`patienttype`,b.`an`
	FROM ( SELECT * FROM `tmp_resulthead` WHERE `patienttype` = 'OPD' ) AS a 
	LEFT JOIN ( SELECT * FROM `tmp_orderhead` WHERE `an` = '' ) AS b ON a.`labnumber` = b.`labnumber` 
	WHERE b.`autonumber` IS NOT NULL
) AS x 
LEFT JOIN (SELECT * FROM `tmp_opday` WHERE `an` IS NULL OR `an` = '' ) AS y ON x.`thdatehn` = y.`thdatehn` 
LEFT JOIN `tmp_labcare` AS z ON x.`profilecode` = z.`codelab` 
WHERE y.`row_id` IS NOT NULL 
AND z.`TMLT` <> '' 
AND z.`detail` IS NOT NULL;



INSERT INTO `client_diagnostic_report` (`source_id`, `id`, `patient_cid`, `encounter_id`, `status`, `category_display`, `category_code`, `category_system`, `code_display`, `code_code`, `code_system`, `effective_date_time`, `effective_period_start`, `effective_period_end`, `performer`, `results_interpreter`, `conclusion`, `conclusion_display`, `conclusion_code`, `deleted`, `last_update_date_time`) 
SELECT 
'001151200' AS `source_id`,
x.`autonumber` AS `id`,
y.`idcard` AS `patient_cid`,
y.`row_id` AS `encounter_id`,
'final' AS `status`,
'Laboratory' AS `category_display`,
'LAB' AS `category_code`,
'hl7-diagnostic-report-category' AS `category_system`,
z.`detail` AS `code_display`,
z.`TMLT` AS `code_code`,
'http://this.or.th/index_TMLT.php' AS `code_system`,
x.`orderdate` AS `effective_date_time`,
'' AS `effective_period_start`,
'' AS `effective_period_end`,
'001151200' AS `performer`,
'' AS `results_interpreter`,
'' AS `conclusion`,
'' AS `conclusion_display`,
'' AS `conclusion_code`,
0 AS `deleted`,
x.`orderdate` AS `last_update_date_time`
FROM ( 
	SELECT a.`autonumber`,a.`labnumber`,a.`orderdate`,a.`profilecode`,a.`testgroupname`,a.`thdatehn`,b.`patienttype`,b.`an`
	FROM ( SELECT * FROM `tmp_resulthead` WHERE `patienttype` = 'IPD' ) AS a 
	LEFT JOIN ( SELECT * FROM `tmp_orderhead` WHERE `an` <> '' ) AS b ON a.`labnumber` = b.`labnumber` 
	WHERE b.`autonumber` IS NOT NULL
) AS x 
LEFT JOIN (SELECT * FROM `tmp_opday` WHERE `an` IS NOT NULL OR `an` <> '' ) AS y ON x.`an` = y.`an` 
LEFT JOIN `tmp_labcare` AS z ON x.`profilecode` = z.`codelab` 
AND z.`TMLT` <> '' 
AND z.`detail` IS NOT NULL;